@model ProjectHub.Models.User

@{
    ViewData["Title"] = "Profili Düzenle";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title">Profili Düzenle</h3>
            </div>
            <div class="card-body">
                <form asp-action="EditProfile" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()

                    <input type="hidden" asp-for="Id" />
                    <input type="hidden" asp-for="Password" />
                    <input type="hidden" asp-for="CreatedAt" />
                    <input type="hidden" asp-for="IsAdmin" />
                    <input type="hidden" asp-for="Username" />

                    <!-- Profil Resmi -->
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            @if (!string.IsNullOrEmpty(Model.ProfileImage) && Model.ProfileImage != "default-profile.png")
                            {
                                <img src="~/uploads/profiles/@Model.ProfileImage"
                                     class="rounded-circle mb-3"
                                     alt="Profil Resmi"
                                     width="150"
                                     height="150"
                                     id="profileImagePreview"
                                     style="object-fit: cover;">
                            }
                            else
                            {
                                <!-- Varsayılan Profil İkonu -->
                                <div class="rounded-circle mb-3 bg-light d-flex align-items-center justify-content-center"
                                     style="width: 150px; height: 150px; border: 3px solid #dee2e6;"
                                     id="profileIcon">
                                    <i class="fas fa-user fa-3x text-secondary"></i>
                                </div>
                            }
                        </div>
                        <div class="mt-3">
                            <label for="profileImage" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-camera me-1"></i> Resim Yükle
                            </label>
                            <input type="file" id="profileImage" name="profileImage" accept="image/*" class="d-none" onchange="previewImage(this)">

                            @if (!string.IsNullOrEmpty(Model.ProfileImage) && Model.ProfileImage != "default-profile.png")
                            {
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImage()">
                                    <i class="fas fa-trash me-1"></i> Resmi Kaldır
                                </button>
                            }
                            <input type="hidden" name="removeProfileImage" id="removeProfileImage" value="false">
                        </div>
                    </div>

                    <!-- Form Alanları -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Username" class="form-label">Kullanıcı Adı</label>
                                <input asp-for="Username" class="form-control" readonly />
                                <small class="form-text text-muted">Kullanıcı adı değiştirilemez.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Email" class="form-label">E-posta *</label>
                                <input asp-for="Email" type="email" class="form-control" required />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label asp-for="ProfileBio" class="form-label">Hakkımda</label>
                        <textarea asp-for="ProfileBio" class="form-control" rows="4" placeholder="Kendinizden bahsedin..."></textarea>
                        <span asp-validation-for="ProfileBio" class="text-danger"></span>
                        <small class="form-text text-muted">Maximum 500 karakter.</small>
                    </div>

                    <!-- Bilgi Kartı -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Üyelik Bilgileri</h6>
                        <p class="mb-0">
                            <strong>Üyelik Tarihi:</strong> @Model.CreatedAt.ToString("dd MMMM yyyy")<br>
                            <strong>Kullanıcı Adı:</strong> @Model.Username<br>
                            <strong>Admin Yetkisi:</strong> @(Model.IsAdmin ? "Var" : "Yok")
                        </p>
                    </div>

                    <!-- Butonlar -->
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-1"></i> Değişiklikleri Kaydet
                        </button>
                    </div>
                </form>

                <div class="text-center mt-3">
                    <a asp-action="Profile" asp-route-username="@Model.Username" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Profile Dön
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    // Resim yüklendiğinde icon'u gizle, resmi göster
                    var profileIcon = document.getElementById('profileIcon');
                    if (profileIcon) {
                        profileIcon.style.display = 'none';
                    }

                    var preview = document.getElementById('profileImagePreview');
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    } else {
                        // Eğer preview elementi yoksa oluştur
                        var newPreview = document.createElement('img');
                        newPreview.id = 'profileImagePreview';
                        newPreview.className = 'rounded-circle mb-3';
                        newPreview.alt = 'Profil Resmi';
                        newPreview.width = 150;
                        newPreview.height = 150;
                        newPreview.src = e.target.result;
                        newPreview.style.display = 'block';
                        newPreview.style.objectFit = 'cover';

                        var container = document.querySelector('.position-relative.d-inline-block');
                        if (profileIcon) {
                            container.insertBefore(newPreview, profileIcon);
                        } else {
                            container.appendChild(newPreview);
                        }
                    }

                    // Remove image hidden input'u sıfırla
                    document.getElementById('removeProfileImage').value = 'false';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            if (confirm('Profil resmini kaldırmak istediğinize emin misiniz?')) {
                var preview = document.getElementById('profileImagePreview');
                if (preview) {
                    preview.style.display = 'none';
                }

                var profileIcon = document.getElementById('profileIcon');
                if (profileIcon) {
                    profileIcon.style.display = 'flex';
                }

                // Remove image hidden input'unu true yap
                document.getElementById('removeProfileImage').value = 'true';

                // File input'unu temizle
                document.getElementById('profileImage').value = '';
            }
        }

        // Form submit öncesi validasyon
        document.querySelector('form').addEventListener('submit', function (e) {
            const email = document.getElementById('Email').value;
            if (!email) {
                e.preventDefault();
                alert('E-posta adresi gereklidir.');
                return false;
            }
            return true;
        });
    </script>
}